sudo: required
dist: trusty
language: ruby

before_install:
before_install:
- gem install asciidoctor -v 1.5.2
- gem install tilt
- sudo pip install git+https://github.com/gitenberg-dev/gitberg
- sudo pip install pillow
- sudo pip install cssutils
- sudo pip install docutils
- sudo pip install roman
- sudo pip install git+https://github.com/gitenberg-dev/pg-epubmaker
script:
- VERSION=`ruby -e "require 'yaml'; meta = YAML.load_file('metadata.yaml'); puts meta['_version'];"`
- git clone https://github.com/gitenberg-dev/asciidoctor-htmlbook.git
- sudo pip install -r asciidoctor-htmlbook/gitberg-machine/requirements.txt

- /usr/bin/python -c "from gitenberg import travis; travis.build_epub()"
- ebook-convert book.epub book.mobi
- xvfb-run ebook-convert book.epub book.pdf
branches:
  only:
  - master
notifications:
  webhooks:
    urls:
      - https://unglue.it/api/travisci/webhook
    on_success: always
    on_failure: never
    on_start: never
deploy:
  skip_cleanup: true
  provider: releases
  api_key:
    secure: JIGpmvcQBmxYgVqBpJPh1K2nBZe+Nt330x68D9aUucajZrgMzgrMtetoxorP3Qga+oQIAcsZgKhJb/nLI31jU+1T0q0tPHiLDo1xGvnVrUJ+sLDRGsO1eqgrsMUjsrk8Kvuf1LtqU4MJSgi7sejw261A97paG/nqMTARyTFhSi+UdfgivLHw6pMqpqdzqMzGZ/2obtkE0iZw9S5MS7xsVJp4as05z/TTF4U9+OjE7NSoCjJXPTfRIAvpmsaOr/cmN5t96eakRxELU4OVis929y2B87bwyzCVdFBhkluYCPLu+jrFssNNkSu8cjcuMn9XzhUMTMh3/fEtfCtWZoTEiaKk4etzx94ksrY62VfQfeGQymDNGVEpBabSi0iZ/FwP/+L5bRkYCjjGrX6ixe9PrA93rT55/yBytYyO3/W2YcEixtU185x36Xkven5XNcbf4K0Ma8xOgi/7/pQgz/M8CbZB/efFymIy46t/R7u5j2CLgifAOwYWBfjFzv/fZ3kzzUJXZKD8bBvcDqRj7qYdQF6cheyfZDYwUZoNtKW04dwrgRuDuI67qHxNjPppBgtMeZexFGRifFCc1apgHbeAlmlkxOKFGldPeEEEFKOtD7HvcHbhpczbnzaDS+QNuVwr/N/5J2lJ2hDATolsim6DxAfKuTlPwHzKu+nKUZLBQX8=
  file:
    - book.epub
    - book.mobi
    - book.pdf
  "on":
    repo: GITenberg/Macbeth_1533
addons:
  apt:
    packages:
    - xsltproc
    - xvfb
    - calibre
    - python-pip
    - git
    - python-dev
    - libjpeg-dev
    - libpng-dev
    - libfreetype6
    - libfreetype6-dev
    - zlib1g-dev
    - python-lxml
    - libxml2-dev
    - libxslt1-dev
    - tidy